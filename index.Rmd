---
title: "Covid-19 Situation in Malaysia"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: https://github.com/wnarifin/covid-19-malaysia/
    navbar:
      - {title: "SIR Model", href: "https://healthdata.usm.my:3939/content/182", align: right}
      - {title: "Vaccination Progress", href: "https://healthdata.usm.my:3939/content/243", align: right}
    theme: default
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(broom)
library(scales)

# --- Data ---

# Data directly from MoH @ https://github.com/MoH-Malaysia/covid19-public

# Issues
# no recovery data @ national & state level
# no icu, ventilation count @ national level
# icu & vent @ state level late update, & sum for all states is not consistent with press release for Malaysia
# will be added once available

# -- Malaysia --
cases_my = read.csv("https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/cases_malaysia.csv")
deaths_my = read.csv("https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/deaths_malaysia.csv")
# vaksin_my = read.csv("https://raw.githubusercontent.com/CITF-Malaysia/citf-public/main/vaccination/vax_malaysia.csv")

# -- State --
cases_state = read.csv("https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/cases_state.csv")
deaths_state = read.csv("https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/deaths_state.csv")
icu_state = read.csv("https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/icu.csv")

# -- Population --
pop_my_state = read.csv("https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/static/population.csv")
pop_my = pop_my_state[pop_my_state$state == "Malaysia", "pop"]

# Prepare date as.Date
cases_my$date = as.Date(cases_my$date)
deaths_my$date = as.Date(deaths_my$date)
# vaksin_my$date = as.Date(vaksin_my$date)
cases_state$date = as.Date(cases_state$date)
deaths_state$date = as.Date(deaths_state$date)
icu_state$date = as.Date(icu_state$date)

sel_date = min(max(cases_my$date), max(deaths_my$date))
sel_date_state = min(max(cases_state$date), max(deaths_state$date))
sel_date_icu = max(icu_state$date)

# Enrich ICU data

# -- Malaysia -- 
icu_my = icu_state %>% group_by(date) %>%
  summarize(
    beds_icu_covid = sum(beds_icu_covid),
    vent = sum(vent),
    icu_covid = sum(icu_covid),
    vent_covid = sum(vent_covid)
  ) %>%
  mutate(icu_util = icu_covid / beds_icu_covid,
         vent_util = vent_covid / vent)

# -- State --
icu_state = icu_state %>% mutate(icu_util = icu_covid / beds_icu_covid,
                                 vent_util = vent_covid / vent)

# Cases - for plotting
data_plot_case = subset(cases_my, select = c(date, cases_new))
data_plot_case$total_cases = cumsum(data_plot_case$cases_new)
data_plot_case = rename(data_plot_case, new_cases = cases_new)

# based on predicted total counts in the past 14 days
data_double = data_plot_case[tail(which(data_plot_case$date >= sel_date - 14), 14),]
data_double$days = 1:14
model1 = glm(total_cases ~ days, family = "quasipoisson", data_double)
summary(model1)
days_to_double = log(2) / coef(model1)[2]

# Deaths - for plotting
data_plot_death = subset(deaths_my, select = c(date, deaths_new))
data_plot_death$total_deaths = cumsum(data_plot_death$deaths_new)
data_plot_death = rename(data_plot_death, new_deaths = deaths_new)

# ICU data - for plotting
data_plot_icu = icu_my
data_plot_icu_state = icu_state

# State cases - for plotting
data_plot_cases_state = cases_state
data_plot_cases_state = rename(data_plot_cases_state, new_cases = cases_new)
data_plot_cases_state = data_plot_cases_state %>% group_by(state) %>% mutate(total_cases = cumsum(new_cases))
data_plot_cases_state = as.data.frame(data_plot_cases_state)

data_plot_deaths_state = deaths_state
data_plot_deaths_state = rename(data_plot_deaths_state, new_deaths = deaths_new)
data_plot_deaths_state = data_plot_deaths_state %>% group_by(state) %>% mutate(total_deaths = cumsum(new_deaths))
data_plot_deaths_state = as.data.frame(data_plot_deaths_state)

# ggplot legend
colors = c("Capacity" = "blue")

# new cases prediction
data_plot_case = data_plot_case %>% mutate(days_tabligh = cumsum(date >= "2020-02-28"),
                                 days_mco = cumsum(date >= "2020-03-18"),
                                 days_cmco = cumsum(date >= "2020-05-04"),
                                 days_rmco1 = cumsum(date >= "2020-06-10"),
                                 days_rmco2 = cumsum(date >= "2020-09-01"),
                                 days_sabah = cumsum(date >= "2020-09-26"),
                                 days_freetvl = cumsum(date >= "2020-12-07"),
                                 days_mco2 = cumsum(date >= "2021-01-13"),
                                 days_schoolre = cumsum(date >= "2021-03-01"),
                                 days_mco3 = cumsum(date >= "2021-06-01"),
                                 days_freevac = cumsum(date >= "2021-08-10"))
# data_plot_case = merge(data_plot_case, 
#                        vaksin_my[, c("date", "dose2_cumul")], 
#                        by = "date", all = TRUE)
# data_plot_case[which(is.na(data_plot_case[, "dose2_cumul"])), "dose2_cumul"] = 0
# new_cases
model_case = glm(new_cases ~ ., data = subset(data_plot_case, select = -c(date, total_cases)), family = "quasipoisson")
# create data frame to predict
max_day = 7
data_case_week = data_plot_case[nrow(data_plot_case), ]
data_case_week = apply(matrix(1:max_day, nrow=max_day), 1, function(x) (data_case_week + x))
data_case_week = bind_rows(data_case_week)
data_case_week[, c("new_cases", "total_cases")] = NA
# data_case_week[, "dose2_cumul"] = data_case_week[, "dose2_cumul"] - 1:max_day  # just use LOCF
data_plot_case = bind_rows(data_plot_case, data_case_week)
data_plot_case$new_cases_predicted = round(predict(model_case, data_plot_case, type = "response"))
data_plot_case$total_cases_predicted = cumsum(data_plot_case$new_cases_predicted)

# new death prediction
data_plot_death = data_plot_death %>% mutate(days_tabligh = cumsum(date >= "2020-02-28"),
                                             days_mco = cumsum(date >= "2020-03-18"),
                                             days_cmco = cumsum(date >= "2020-05-04"),
                                             days_rmco1 = cumsum(date >= "2020-06-10"),
                                             days_rmco2 = cumsum(date >= "2020-09-01"),
                                             days_sabah = cumsum(date >= "2020-09-26"),
                                             days_freetvl = cumsum(date >= "2020-12-07"),
                                             days_mco2 = cumsum(date >= "2021-01-13"),
                                             days_schoolre = cumsum(date >= "2021-03-01"),
                                             days_mco3 = cumsum(date >= "2021-06-01"),
                                             days_freevac = cumsum(date >= "2021-08-10"))
# data_plot_death = merge(data_plot_death, 
#                        vaksin_my[, c("date", "dose2_cumul")], 
#                        by = "date", all = TRUE)
# data_plot_death[which(is.na(data_plot_death[, "dose2_cumul"])), "dose2_cumul"] = 0
# new_deaths
model_death = glm(new_deaths ~ ., data = subset(data_plot_death, select = -c(date, days_mco, total_deaths)), family = "quasipoisson")
# create data frame to predict
max_day = 7
data_death_week = data_plot_death[nrow(data_plot_death), ]
data_death_week = apply(matrix(1:max_day, nrow=max_day), 1, function(x) (data_death_week + x))
data_death_week = bind_rows(data_death_week)
data_death_week[, c("new_deaths", "total_deaths")] = NA
# data_death_week[, "dose2_cumul"] = data_death_week[, "dose2_cumul"] - 1:max_day  # just use LOCF
data_death_week
data_plot_death = bind_rows(data_plot_death, data_death_week)
data_plot_death$new_deaths_predicted = round(predict(model_death, data_plot_death, type = "response"))
data_plot_death$total_deaths_predicted = cumsum(data_plot_death$new_deaths_predicted)

# to do: add vaccination as factor, eg. dose2_cumul
# issues: using LOCF, model too optimistic, massive reduction in cases w/in days
# sometime update of vaksin_my late by 1 day, difficult to ensure consistency of the dashboard
```

# Overview

## Row

### Data by `r paste0(format(sel_date, "%d %B %Y"), ", 11:59PM")`. {.value-box}

```{r}
valueBox(
  value = "",
)
```

## Row

### New cases {.value-box}

```{r}
valueBox(
  value = data_plot_case[data_plot_case$date == sel_date, "new_cases"],
  icon = "fa-area-chart",
  color = "orange"
)
```

<!-- ### Active cases {.value-box} -->

<!-- ```{r} -->

<!-- valueBox( -->

<!--   value = data_plot_case[dim(covid_my_full)[1], "total_cases"] - covid_my_full[dim(covid_my_full)[1], "total_recover"] - covid_my_full[dim(covid_my_full)[1], "total_deaths"], -->

<!--   icon = "fa-area-chart", -->

<!--   color = "orange" -->

<!-- ) -->

<!-- ``` -->

### Total cases {.value-box}

```{r}
valueBox(
  value = data_plot_case[data_plot_case$date == sel_date, "total_cases"],
  icon = "fa-area-chart",
  color = "orange"
)
```

### cases per 100,000 persons {.value-box}

```{r}
# Malaysian population is 32.68 mil at 4th quarter 2019
valueBox(
  value = round(data_plot_case[data_plot_case$date == sel_date, "total_cases"] / pop_my * 10^5, 2),
  icon = "fa-area-chart",
  color = "orange"
)
```

### days to double the number of total cases {.value-box}

```{r}
valueBox(
  value = round(days_to_double, 2),
  icon = "fa-area-chart",
  color = "orange"
)
```

## Row

### New deaths {.value-box}

```{r}
valueBox(
  value = data_plot_death[data_plot_death$date == sel_date, "new_deaths"],
  icon = "fa-area-chart",
  color = "red"
)
```

### Total deaths {.value-box}

```{r}
valueBox(
  value = data_plot_death[data_plot_death$date == sel_date, "total_deaths"],
  icon = "fa-area-chart",
  color = "red"
)
```

### deaths per 1000 cases {.value-box}

```{r}
valueBox(
  value = round(data_plot_death[data_plot_death$date == sel_date, "total_deaths"] / data_plot_case[data_plot_case$date == sel_date, "total_cases"] * 1000, 2),
  icon = "fa-area-chart",
  color = "red"
)
```

<!-- Row -->

<!-- --- -->

<!-- ### in ICU {.value-box} -->

<!-- ```{r} -->

<!-- valueBox( -->

<!--   value = covid_my_full[dim(covid_my_full)[1], "icu"], -->

<!--   icon = "fa-area-chart", -->

<!--   color = "blue" -->

<!-- ) -->

<!-- ``` -->

<!-- ### require breathing support {.value-box} -->

<!-- ```{r} -->

<!-- valueBox( -->

<!--   value = covid_my_full[dim(covid_my_full)[1], "support"], -->

<!--   icon = "fa-area-chart", -->

<!--   color = "blue" -->

<!-- ) -->

<!-- ``` -->

<!-- Row -->

<!-- --- -->

<!-- ### Recovered {.value-box} -->

<!-- ```{r} -->

<!-- valueBox( -->

<!--   value = covid_my_full[dim(covid_my_full)[1], "recover"], -->

<!--   icon = "fa-area-chart", -->

<!--   color = "green" -->

<!-- ) -->

<!-- ``` -->

<!-- ### Total recovered {.value-box} -->

<!-- ```{r} -->

<!-- valueBox( -->

<!--   value = covid_my_full[dim(covid_my_full)[1], "total_recover"], -->

<!--   icon = "fa-area-chart", -->

<!--   color = "green" -->

<!-- ) -->

<!-- ``` -->

<!-- ### recovered per 1000 cases {.value-box} -->

<!-- ```{r} -->

<!-- valueBox( -->

<!--   value = round(covid_my_full[dim(covid_my_full)[1], "total_recover"] / covid_my_full[dim(covid_my_full)[1], "total_cases"] * 1000, 2), -->

<!--   icon = "fa-area-chart", -->

<!--   color = "green" -->

<!-- ) -->

<!-- ``` -->

## Row

### The date of data update depends on the availability of the data from MoH github. Recovery data is not yet available in MoH github. {.value-box}
```{r}
valueBox(
  value = "",
)
```

# Cases

## Row

### Data by `r paste0(format(sel_date, "%d %B %Y"), ", 11:59PM")`. {.value-box}

```{r}
valueBox(
  value = "",
)
```

## Row

### new cases today {.value-box}

```{r}
valueBox(
  value = data_plot_case[data_plot_case$date == sel_date, "new_cases"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

### new cases expected tomorrow  {.value-box}

```{r}

valueBox(

  value = data_plot_case[data_plot_case$date == sel_date + 1, "new_cases_predicted"],

  #icon = "fa-area-chart",

  color = "orange"

)

```

### additional new cases expected in 3 days  {.value-box}

```{r}

valueBox(

  value = data_plot_case[data_plot_case$date == sel_date + 3, "total_cases_predicted"] - data_plot_case[data_plot_case$date == sel_date, "total_cases_predicted"],

  #icon = "fa-area-chart",

  color = "orange"

)

```

### additional new cases expected in a week  {.value-box}

```{r}

valueBox(

  value = data_plot_case[data_plot_case$date == sel_date + 7, "total_cases_predicted"] - data_plot_case[data_plot_case$date == sel_date, "total_cases_predicted"],

  #icon = "fa-area-chart",

  color = "orange"

)

```

### total cases today {.value-box}

```{r}
valueBox(
  value = data_plot_case[data_plot_case$date == sel_date, "total_cases"],
  #icon = "fa-area-chart",
  color = "orange"
)
```

### total cases expected in a week  {.value-box}

```{r}

valueBox(

  value = data_plot_case[data_plot_case$date == sel_date + 7, "total_cases_predicted"] - data_plot_case[data_plot_case$date == sel_date, "total_cases_predicted"] + data_plot_case[data_plot_case$date == sel_date, "total_cases"],

  #value = data_plot_case[data_plot_case$date == sel_date + 7, "total_cases_predicted"],

  #icon = "fa-area-chart",

  color = "orange"

)

```

## Row

### New cases, hover/tap on the graph for details.

```{r}
# daily
offset_case = max(data_plot_case$new_cases, na.rm=T)/10
plot_case = ggplot(data_plot_case) +
  geom_col(aes(x = date, y = new_cases), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = new_cases_predicted), color = "blue", alpha = 0.7) +
  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = as.numeric(as.Date("2020-02-28")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-02-28")+2, y = max(data_plot_case$new_cases, na.rm=T)-offset_case, label = "Tabligh", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-18")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-03-18")+2, y = max(data_plot_case$new_cases, na.rm=T)-75, label = "MCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-05-04")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-05-04")+2, y = max(data_plot_case$new_cases, na.rm=T)-offset_case, label = "CMCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-06-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-06-10")+2, y = max(data_plot_case$new_cases, na.rm=T)-75, label = "RMCO1", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-01")+2, y = max(data_plot_case$new_cases, na.rm=T)-offset_case, label = "RMCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-26")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-26")+2, y = max(data_plot_case$new_cases, na.rm=T)-75, label = "Sabah\nElection", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-12-07")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-12-07")+2, y = max(data_plot_case$new_cases, na.rm=T)-offset_case, label = "Free\nTravel", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-01-13")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-01-13")+2, y = max(data_plot_case$new_cases, na.rm=T)-75, label = "MCO2", angle = 90) +
  labs(x = "Date", y = "New cases", title = paste0("New cases by ", format(sel_date, "%d %B %Y"))) +
  geom_vline(xintercept = as.numeric(as.Date("2021-03-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-03-01")+2, y = max(data_plot_case$new_cases, na.rm=T)-offset_case, label = "School\nReopened", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-06-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-06-01")+2, y = max(data_plot_case$new_cases, na.rm=T)-75, label = "MCO3", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-08-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-08-10")+2, y = max(data_plot_case$new_cases, na.rm=T)-offset_case, label = "Free\nTravel\nfor\nVaccinated", angle = 90) +
  labs(x = "Date", y = "New cases", title = paste0("New cases by ", format(sel_date, "%d %B %Y"))) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))# +
  theme_classic()
plot_case
ggplotly(plot_case)
```

### Total cases, hover/tap on the graph for details.

```{r}
# cumulative
offset_total_case = max(data_plot_case$total_cases, na.rm=T)/10
plot_total_case = ggplot(data_plot_case) +
  geom_col(aes(x = date, y = total_cases), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = total_cases_predicted), color = "blue", alpha = 0.7) +
  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = as.numeric(as.Date("2020-02-28")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-02-28")+2, y = max(data_plot_case$total_cases, na.rm=T)-offset_total_case, label = "Tabligh", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-18")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-03-18")+2, y = max(data_plot_case$total_cases, na.rm=T)-75, label = "MCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-05-04")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-05-04")+2, y = max(data_plot_case$total_cases, na.rm=T)-offset_total_case, label = "CMCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-06-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-06-10")+2, y = max(data_plot_case$total_cases, na.rm=T)-75, label = "RMCO1", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-01")+2, y = max(data_plot_case$total_cases, na.rm=T)-offset_total_case, label = "RMCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-26")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-26")+2, y = max(data_plot_case$total_cases, na.rm=T)-75, label = "Sabah\nElection", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-12-07")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-12-07")+2, y = max(data_plot_case$total_cases, na.rm=T)-offset_total_case, label = "Free\nTravel", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-01-13")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-01-13")+2, y = max(data_plot_case$total_cases, na.rm=T)-75, label = "MCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-03-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-03-01")+2, y = max(data_plot_case$total_cases, na.rm=T)-offset_total_case, label = "School\nReopened", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-06-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-06-01")+2, y = max(data_plot_case$total_cases, na.rm=T)-75, label = "MCO3", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-08-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-08-10")+2, y = max(data_plot_case$total_cases, na.rm=T)-offset_total_case, label = "Free\nTravel\nfor\nVaccinated", angle = 90) +
  labs(x = "Date", y = "Cumulative cases", title = paste0("Total cases by ", format(sel_date, "%d %B %Y"))) +
  theme_classic()
plot_total_case
ggplotly(plot_total_case)
```

## Row

### **Note**: Predicted cases in blue line. Based on quasipoisson regression model of the major events (MCO, tabligh gathering, Sabah election etc.) and cumulative number of completed vaccination dose.{.value-box}
```{r}
valueBox(
  value = "",
)
```

# Deaths

## Row

### Data by `r paste0(format(sel_date, "%d %B %Y"), ", 11:59PM")`. {.value-box}

```{r}
valueBox(
  value = "",
)
```

## Row

### new deaths today {.value-box}

```{r}
valueBox(
  value = data_plot_death[data_plot_death$date == sel_date, "new_deaths"],
  #icon = "fa-area-chart",
  color = "red"
)
```

### new deaths expected tomorrow  {.value-box}

```{r}

valueBox(

  value = data_plot_death[data_plot_death$date == sel_date + 1, "new_deaths_predicted"],

  #icon = "fa-area-chart",

  color = "red"

)

```

### additional new deaths expected in 3 days  {.value-box}

```{r}

valueBox(

  value = data_plot_death[data_plot_death$date == sel_date + 3, "total_deaths_predicted"] - data_plot_death[data_plot_death$date == sel_date, "total_deaths_predicted"],

  #icon = "fa-area-chart",

  color = "red"

)

```

### additional new deaths expected in a week  {.value-box}

```{r}

valueBox(

  value = data_plot_death[data_plot_death$date == sel_date + 7, "total_deaths_predicted"] - data_plot_death[data_plot_death$date == sel_date, "total_deaths_predicted"],

  #icon = "fa-area-chart",

  color = "red"

)

```

### total deaths today {.value-box}

```{r}
valueBox(
  value = data_plot_death[data_plot_death$date == sel_date, "total_deaths"],
  #icon = "fa-area-chart",
  color = "red"
)
```

### total deaths expected in a week  {.value-box}

```{r}

valueBox(

  data_plot_death[data_plot_death$date == sel_date + 7, "total_deaths_predicted"] - data_plot_death[data_plot_death$date == sel_date, "total_deaths_predicted"] + data_plot_death[data_plot_death$date == sel_date, "total_deaths"],

  #value = data_plot_death[data_plot_death$date == sel_date + 7, "total_deaths_predicted"],

  #icon = "fa-area-chart",

  color = "red"

)

```

## Row

### New deaths, hover/tap on the graph for details.

```{r}
# daily
offset_death = max(data_plot_death$new_deaths, na.rm=T)/10
plot_death = ggplot(data_plot_death) +
  geom_col(aes(x = date, y = new_deaths), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = new_deaths_predicted), color = "blue", alpha = 0.7) +
  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +
  scale_y_continuous(labels = label_comma(), limits = c(0, max(data_plot_death$new_deaths, na.rm=T)+50)) +
  geom_vline(xintercept = as.numeric(as.Date("2020-02-28")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-02-28")+2, y = max(data_plot_death$new_deaths, na.rm=T)-offset_death, label = "Tabligh", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-18")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-03-18")+2, y = max(data_plot_death$new_deaths, na.rm=T)+30, label = "MCO",angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-05-04")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-05-04")+2, y = max(data_plot_death$new_deaths, na.rm=T)-offset_death, label = "CMCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-06-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-06-10")+2, y = max(data_plot_death$new_deaths, na.rm=T)+30, label = "RMCO1", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-01")+2, y = max(data_plot_death$new_deaths, na.rm=T)-offset_death, label = "RMCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-26")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-26")+2, y = max(data_plot_death$new_deaths, na.rm=T)+30, label = "Sabah\nElection", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-12-07")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-12-07")+2, y = max(data_plot_death$new_deaths, na.rm=T)-offset_death, label = "Free\nTravel", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-01-13")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-01-13")+2, y = max(data_plot_death$new_deaths, na.rm=T)+30, label = "MCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-03-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-03-01")+2, y = max(data_plot_death$new_deaths, na.rm=T)-offset_death, label = "School\nReopened", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-06-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-06-01")+2, y = max(data_plot_death$new_deaths, na.rm=T)+30, label = "MCO3", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-08-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-08-10")+2, y = max(data_plot_death$new_deaths, na.rm=T)-offset_death, label = "Free\nTravel\nfor\nVaccinated", angle = 90) +
  labs(x = "Date", y = "New deaths", title = paste0("New deaths by ", format(sel_date, "%d %B %Y"))) +
  theme_classic()
plot_death
ggplotly(plot_death)
```

### Total deaths, hover/tap on the graph for details.

```{r}
# cumulative
offset_total_death = max(data_plot_death$total_deaths, na.rm=T)/10
plot_total_death = ggplot(data_plot_death) +
  geom_col(aes(x = date, y = total_deaths), fill = "red", alpha = 0.7) +
  geom_line(aes(x = date, y = total_deaths_predicted), color = "blue", alpha = 0.7) +
  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +
  scale_y_continuous(labels = label_comma(), limits = c(0, max(data_plot_death$total_deaths, na.rm=T)+50)) +
  geom_vline(xintercept = as.numeric(as.Date("2020-02-28")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-02-28")+2, y = max(data_plot_death$total_deaths, na.rm=T)-offset_total_death, label = "Tabligh", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-18")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-03-18")+2, y = max(data_plot_death$total_deaths, na.rm=T)+30, label = "MCO",angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-05-04")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-05-04")+2, y = max(data_plot_death$total_deaths, na.rm=T)-offset_total_death, label = "CMCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-06-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-06-10")+2, y = max(data_plot_death$total_deaths, na.rm=T)+30, label = "RMCO1", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-01")+2, y = max(data_plot_death$total_deaths, na.rm=T)-offset_total_death, label = "RMCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-26")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-26")+2, y = max(data_plot_death$total_deaths, na.rm=T)+30, label = "Sabah\nElection", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-12-07")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-12-07")+2, y = max(data_plot_death$total_deaths, na.rm=T)-offset_total_death, label = "Free\nTravel", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-01-13")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-01-13")+2, y = max(data_plot_death$total_deaths, na.rm=T)+30, label = "MCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-03-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-03-01")+2, y = max(data_plot_death$total_deaths, na.rm=T)-offset_total_death, label = "School\nReopened", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-06-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-06-01")+2, y = max(data_plot_death$total_deaths, na.rm=T)+30, label = "MCO3", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-08-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-08-10")+2, y = max(data_plot_death$total_deaths, na.rm=T)-offset_total_death, label = "Free\nTravel\nfor\nVaccinated", angle = 90) +
  labs(x = "Date", y = "Cumulative deaths", title = paste0("Total deaths by ", format(sel_date, "%d %B %Y"))) +
  theme_classic()
plot_total_death
ggplotly(plot_total_death)
```

## Row

### **Note**: Predicted deaths in blue line. Based on quasipoisson regression model of the major events (MCO, tabligh gathering, Sabah election etc.) and cumulative number of completed vaccination dose.{.value-box}
```{r}
valueBox(
  value = "",
)
```

# ICU

## Row

### Data by `r paste0(format(sel_date_icu, "%d %B %Y"), ", 11:59PM")`. {.value-box}

```{r}
valueBox(
  value = "",
)
```

## Row

### total dedicated ICU beds for COVID-19{.value-box}

```{r}
valueBox(
  value = data_plot_icu[data_plot_icu$date == sel_date_icu, "beds_icu_covid"],
  #icon = "fa-area-chart",
  color = "blue"
)
```

### total ICU beds used for COVID-19 patients{.value-box}

```{r}
valueBox(
  value = data_plot_icu[data_plot_icu$date == sel_date_icu, "icu_covid"],
  #icon = "fa-area-chart",
  color = "blue"
)
```

### ICU bed utilization {.value-box}

```{r}
valueBox(
  value = paste(round(data_plot_icu[data_plot_icu$date == sel_date_icu, "icu_util"] * 100, 2), "%"),
  #icon = "fa-area-chart",
  color = "blue"
)
```

### total available ventilators{.value-box}

```{r}
valueBox(
  value = data_plot_icu[data_plot_icu$date == sel_date_icu, "vent"],
  #icon = "fa-area-chart",
  color = "green"
)
```

### total ventilators used for COVID-19 patients{.value-box}

```{r}
valueBox(
  value = data_plot_icu[data_plot_icu$date == sel_date_icu, "vent_covid"],
  #icon = "fa-area-chart",
  color = "green"
)
```

### ventilator utilization {.value-box}

```{r}
valueBox(
  value = paste(round(data_plot_icu[data_plot_icu$date == sel_date_icu, "vent_util"] * 100, 2), "%"),
  #icon = "fa-area-chart",
  color = "green"
)
```

## Row

### ICU beds used for COVID-19, hover/tap on the graph for details.

```{r}
# icu
offset_icu = max(data_plot_icu$icu_covid, na.rm=T)/10
plot_icu = ggplot(data_plot_icu, aes(x = date)) +
  geom_col(aes(y = icu_covid), fill = "red", alpha = 0.7) +
  geom_line(aes(y = beds_icu_covid, color = "Capacity")) +
  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = as.numeric(as.Date("2020-02-28")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-02-28")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-offset_icu, label = "Tabligh", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-18")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-03-18")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-75, label = "MCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-05-04")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-05-04")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-offset_icu, label = "CMCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-06-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-06-10")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-75, label = "RMCO1", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-01")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-offset_icu, label = "RMCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-26")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-26")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-75, label = "Sabah\nElection", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-12-07")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-12-07")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-offset_icu, label = "Free\nTravel", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-01-13")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-01-13")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-75, label = "MCO2", angle = 90) +
  labs(x = "Date", y = "New cases", title = paste0("New cases by ", format(sel_date, "%d %B %Y"))) +
  geom_vline(xintercept = as.numeric(as.Date("2021-03-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-03-01")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-offset_icu, label = "School\nReopened", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-06-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-06-01")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-75, label = "MCO3", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-08-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-08-10")+2, y = max(data_plot_icu$icu_covid, na.rm=T)-offset_icu, label = "Free\nTravel\nfor\nVaccinated", angle = 90) +
  labs(x = "Date", y = "ICU beds", title = paste0("ICU beds used for COVID-19 by ", format(sel_date_icu, "%d %B %Y")),
       color = "Legend") +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))# +
  scale_colour_manual(values = colors) +
  theme_classic()
plot_icu
ggplotly(plot_icu)
```

### Ventilators used for COVID-19, hover/tap on the graph for details.

```{r}
# vent
offset_vent = max(data_plot_icu$vent_covid, na.rm=T)/10
plot_vent = ggplot(data_plot_icu, aes(x = date)) +
  geom_col(aes(y = vent_covid), fill = "red", alpha = 0.7) +
  geom_line(aes(y = vent, color = "Capacity")) +
  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = as.numeric(as.Date("2020-02-28")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-02-28")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-offset_icu, label = "Tabligh", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-18")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-03-18")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-75, label = "MCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-05-04")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-05-04")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-offset_icu, label = "CMCO", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-06-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-06-10")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-75, label = "RMCO1", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-01")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-offset_icu, label = "RMCO2", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-09-26")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-09-26")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-75, label = "Sabah\nElection", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2020-12-07")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2020-12-07")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-offset_icu, label = "Free\nTravel", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-01-13")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-01-13")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-75, label = "MCO2", angle = 90) +
  labs(x = "Date", y = "New cases", title = paste0("New cases by ", format(sel_date, "%d %B %Y"))) +
  geom_vline(xintercept = as.numeric(as.Date("2021-03-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-03-01")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-offset_icu, label = "School\nReopened", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-06-01")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-06-01")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-75, label = "MCO3", angle = 90) +
  geom_vline(xintercept = as.numeric(as.Date("2021-08-10")), linetype = "dotted") +
  annotate(geom = "text", x = as.Date("2021-08-10")+2, y = max(data_plot_icu$vent_covid, na.rm=T)-offset_icu, label = "Free\nTravel\nfor\nVaccinated", angle = 90) +
  labs(x = "Date", y = "Ventilators", title = paste0("Ventilators used for COVID-19 by ", format(sel_date_icu, "%d %B %Y")),
       color = "Legend") +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))# +
  scale_colour_manual(values = colors) +
  theme_classic()
plot_vent
ggplotly(plot_vent)
```

## Row

### **Note**: The number of COVID-19 patients in ICU and ventilator support was calculated based the counts in the state data. This is different from the number reported in press release because of the difference in date and time of update as clarified with the MoH github page maintainer. {.value-box}
```{r}
valueBox(
  value = "",
)
```

# Cases by State

## Row

### Data by `r paste0(format(sel_date_state, "%d %B %Y"), ", 11:59PM")`. {.value-box}

```{r}

valueBox(

  value = "",

)

```

## Row

### New cases, hover/tap on the graph for details.

```{r}

# daily

plot_cases_state = ggplot(data = data_plot_cases_state) +

  geom_col(aes(x=date, y=new_cases, fill=state)) +

  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y", limits = c(min(data_plot_cases_state$date), NA)) +

  scale_y_continuous(labels = label_comma()) +

  scale_fill_discrete(name="State") +

  labs(x="Date", y="New cases") +

  theme_classic()

plot_cases_state

ggplotly(plot_cases_state)

```

### Total cases, hover/tap on the graph for details.

```{r}

# cumulative

plot_cases_state_cum = ggplot(data = data_plot_cases_state) +

  geom_col(aes(x=date, y=total_cases, fill=state)) +

  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +

  scale_y_continuous(labels = label_comma()) +

  scale_fill_discrete(name="State") +

  labs(x="Date", y="Cumulative cases") +

  theme_classic()

plot_cases_state_cum

ggplotly(plot_cases_state_cum)

```

# Deaths by State

## Row

### Data by `r paste0(format(sel_date_state, "%d %B %Y"), ", 11:59PM")`. {.value-box}

```{r}

valueBox(

  value = "",

)

```

## Row

### New deaths, hover/tap on the graph for details.

```{r}

# daily

plot_deaths_state = ggplot(data = data_plot_deaths_state) +

  geom_col(aes(x=date, y=new_deaths, fill=state)) +

  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +

  scale_y_continuous(labels = label_comma()) +

  scale_fill_discrete(name="State") +

  labs(x="Date", y="New deaths") +

  theme_classic()

plot_deaths_state

ggplotly(plot_deaths_state)

```

### Total deaths, hover/tap on the graph for details.

```{r}

# cumulative

plot_deaths_state_cum = ggplot(data = data_plot_deaths_state) +

  geom_col(aes(x=date, y=total_deaths, fill=state)) +

  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +

  scale_y_continuous(labels = label_comma()) +

  scale_fill_discrete(name="State") +

  labs(x="Date", y="Cumulative deaths") +

  theme_classic()

plot_deaths_state_cum

ggplotly(plot_deaths_state_cum)

```

# ICU by State

## Row

### Data by `r paste0(format(sel_date_icu, "%d %B %Y"), ", 11:59PM")`. {.value-box}

```{r}

valueBox(

  value = "",

)

```

## Row

### ICU beds used for COVID-19, hover/tap on the graph for details.

```{r}

# daily

plot_icu_state = ggplot(data = data_plot_icu_state) +

  geom_col(aes(x=date, y=icu_covid, fill=state)) +

  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y", limits = c(min(data_plot_icu_state$date), NA)) +

  scale_y_continuous(labels = label_comma()) +

  scale_fill_discrete(name="State") +

  labs(x="Date", y="ICU beds") +

  theme_classic()

plot_icu_state

ggplotly(plot_icu_state)

```

### Ventilators used for COVID-19, hover/tap on the graph for details.

```{r}

# cumulative

plot_vent_state_cum = ggplot(data = data_plot_icu_state) +

  geom_col(aes(x=date, y=vent_covid, fill=state)) +

  scale_x_date(date_breaks = "84 day", date_labels = "%d/%m/%y") +

  scale_y_continuous(labels = label_comma()) +

  scale_fill_discrete(name="State") +

  labs(x="Date", y="Ventilators") +

  theme_classic()

plot_vent_state_cum

ggplotly(plot_vent_state_cum)

```

# Data and Our Team

## Row

### 

**The data are sourced from:**

-   Open data on COVID-19 in Malaysia: <https://github.com/MoH-Malaysia/covid19-public>.
-   Last update on `r format(Sys.Date(), "%d %B %Y")`.

** Other sources that we used on previous dashboard version: **
-   Ourworldindata: <https://covid.ourworldindata.org/data/ecdc/full_data.csv> (up to 21/3/2020).
-   Ministry of Health of Malaysia press statement: <https://kpkesihatan.com/>, <http://www.moh.gov.my/index.php/pages/view/2019-ncov-wuhan-kenyataan-akhbar>, <https://www.facebook.com/kkmcprc/>
-   Our edited data can be accessed from <https://data.world/wnarifin/covid-19-my/> and <https://github.com/wnarifin/covid-19-malaysia>. (no longer updated as of 3/8/2021 because of the availablility of the data from MoH)

**Epidemiology Modelling Team members, School of Medical Sciences, Universiti Sains Malaysia (USM):**

Department of Community Medicine:

-   [Assoc. Prof. Dr. Kamarul Imran Musa (Dr. KIM)](https://myanalytics.com.my/)
-   Dr. Mohd Azmi B. Suliman
-   Dr. Mohamad Zarudin B Mat Said
-   Dr. Wira Alfatah B Ab Ayah \@ Ab Aziz
-   Dr. Che Muhammad Nur Hidayat B Che Nawi
-   Dr. Afiqah Syamimi Bt Masrani
-   Mr. Tengku Muhammad Hanis B Tengku Mokhtar

Biostatistics and Research Methodology Unit:

-   [Dr. Wan Nor Arifin](https://wnarifin.github.io/)

Jabatan Kesihatan Negeri, Pahang:

-   Dr. Sahrol Azmi

Pusat Data PPKT Kampus Kesihatan:

-   Mohd Fadzali Bakar
-   Mohd Faizal Abdul Manaf
-   Ahmad Syakiren Mazalan

**Disclaimer: We and USM are not responsible for any damage or inconvenience caused directly or indirectly by the use of this dashboard.**

We built this dashboard using

-   RStudio

-   Packages:

    -   flexdashboard
    -   tidyverse
    -   plotly
    -   broom
